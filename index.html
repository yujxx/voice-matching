<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speaker Tone Evaluation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 30px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .hidden {
            display: none;
        }
        .button {
            padding: 12px 24px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 0;
        }
        .button:hover {
            background-color: #45a049;
        }
        .score-buttons {
            margin: 20px 0;
        }
        .score-button {
            padding: 10px 20px;
            margin: 0 10px;
            border: 2px solid #4CAF50;
            background-color: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .score-button:hover {
            background-color: #4CAF50;
            color: white;
        }
        .score-button.selected {
            background-color: #4CAF50;
            color: white;
        }
        .text-content {
            margin: 20px 0;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 5px;
            white-space: pre-line;
        }
        .progress {
            margin: 20px 0;
            font-weight: bold;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container" id="guidance-page">
        <h1>Speaker Tone Evaluation Test</h1>
        <div class="text-content">
            On this test page, you will go through 40 items. Each item includes an audio file and a corresponding text file. The text will display the speakers and their dialogue, with three speakers in each conversation. Your task is to listen to the audio, read the text, and judge whether the tone of each speaker matches the current context and scenario based on your subjective impression. Then, provide a rating from 0 to 3:

            0: Completely does not match
            1: Only one speaker matches
            2: Two speakers match
            3: All speakers mostly match

            During the audio playback, you can drag the progress bar; you only need to ensure you hear the parts where all three speakers are talking, without needing to listen to each speaker's complete dialogue.
        </div>
        <button class="button" onclick="startTest()">Start Evaluation</button>
    </div>

    <div class="container hidden" id="test-page">
        <div class="progress">Progress: <span id="progress-text">1/40</span></div>
        <audio id="audio-player" controls style="width: 100%"></audio>
        <div class="text-content" id="text-content"></div>
        <div class="score-buttons">
            <button class="score-button" onclick="selectScore(0)">0</button>
            <button class="score-button" onclick="selectScore(1)">1</button>
            <button class="score-button" onclick="selectScore(2)">2</button>
            <button class="score-button" onclick="selectScore(3)">3</button>
        </div>
        <button class="button" id="next-button" onclick="nextItem()" disabled>Next</button>
    </div>

    <div class="container hidden" id="result-page">
        <h2>Evaluation Results</h2>
        <div class="text-content">
            <p>Average Score: <span id="average-score"></span></p>
            <p>Detailed Scores:</p>
            <pre id="detailed-scores"></pre>
        </div>
        <button class="button" onclick="downloadResults()">Download Results</button>
    </div>

    <script>
        let audioFiles = [];
        let textFiles = [];
        let currentIndex = 0;
        let scores = [];
        let selectedScore = null;

        async function loadFileList() {
            try {
                const response = await fetch('audio/');
                const text = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(text, 'text/html');
                audioFiles = Array.from(doc.querySelectorAll('a'))
                    .map(a => a.href)
                    .filter(href => href.endsWith('.wav'))
                    .sort();
            } catch (error) {
                console.error('Error loading file list:', error);
            }
        }

        async function startTest() {
            await loadFileList();
            document.getElementById('guidance-page').classList.add('hidden');
            document.getElementById('test-page').classList.remove('hidden');
            loadItem();
        }

        async function loadItem() {
            if (currentIndex >= audioFiles.length) {
                showResults();
                return;
            }

            // Reset score buttons
            document.querySelectorAll('.score-button').forEach(btn => {
                btn.classList.remove('selected');
            });
            document.getElementById('next-button').disabled = true;
            selectedScore = null;

            // Update progress
            document.getElementById('progress-text').textContent = `${currentIndex + 1}/${audioFiles.length}`;

            // Load audio
            const audioPlayer = document.getElementById('audio-player');
            audioPlayer.src = audioFiles[currentIndex];

            // Load text
            const textFileName = audioFiles[currentIndex].replace('audio/', 'text/').replace('.wav', '.txt');
            try {
                const response = await fetch(textFileName);
                const text = await response.text();
                document.getElementById('text-content').textContent = text;
            } catch (error) {
                console.error('Error loading text file:', error);
            }
        }

        function selectScore(score) {
            selectedScore = score;
            document.querySelectorAll('.score-button').forEach(btn => {
                btn.classList.remove('selected');
            });
            document.querySelectorAll('.score-button')[score].classList.add('selected');
            document.getElementById('next-button').disabled = false;
        }

        function nextItem() {
            scores[currentIndex] = selectedScore;
            currentIndex++;
            loadItem();
        }

        function showResults() {
            const average = scores.reduce((a, b) => a + b, 0) / scores.length;
            document.getElementById('test-page').classList.add('hidden');
            document.getElementById('result-page').classList.remove('hidden');
            document.getElementById('average-score').textContent = average.toFixed(2);
            
            const detailedScores = audioFiles.map((file, index) => {
                const fileName = file.split('/').pop();
                return `${fileName}: ${scores[index]}`;
            }).join('\n');
            document.getElementById('detailed-scores').textContent = detailedScores;
        }

        function downloadResults() {
            const results = {
                average: scores.reduce((a, b) => a + b, 0) / scores.length,
                detailed: audioFiles.map((file, index) => ({
                    file: file.split('/').pop(),
                    score: scores[index]
                }))
            };

            const blob = new Blob([JSON.stringify(results, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'evaluation_results.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
